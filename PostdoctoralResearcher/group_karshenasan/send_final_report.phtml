<?
include("include/database-connect.phtml");
include("include/include.phtml");
header_forms($admin,$seed);
include("include/styles.phtml");

echo "<br>";
 
 
  if (strcmp($action,"delete_file")==0)
  {
   	
  	$del_file="../reports/".$cod_tarh;
    //echo $delete_id;
	delete_file($del_file,"",$delete_id);
    
    //$query="delete  from marhale_report where id='$delete_id'";
  	//$result=mysql_query($query);
    $step=4;
  }
 

if(isset($action))
{
  if (strcmp($action,"sabt")==0)
  {
  
  
     if($step==1)
     {
     	if(strlen(trim($natayej))>0 && strlen(trim($ravesh_ejra)) > 0)
     	{
     	$query="select * from  marhale_report where  marhale='100' and cod_tarh='$cod_tarh'";	 
	 
	   	$result=mysql_query($query) or die("Error");
     
	    if(mysql_num_rows($result) <= 0)
	    {
	     	
	     	
	      $sazmanha=str_replace("'"," ",$sazmanha);
	      $sazmanha=str_replace("\""," ",$sazmanha);
	      $sazmanha=str_replace(";"," ",$sazmanha);
	
    	  $pishnahadat=str_replace("'"," ",$pishnahadat);
	      $pishnahadat=str_replace("\""," ",$pishnahadat);
	      $pishnahadat=str_replace(";"," ",$pishnahadat);

    	  $natije_giri=str_replace("'"," ",$natije_giri);
	      $natije_giri=str_replace("\""," ",$natije_giri);
	      $natije_giri=str_replace(";"," ",$natije_giri);

    	  $natayej=str_replace("'"," ",$natayej);
	      $natayej=str_replace("\""," ",$natayej);
	      $natayej=str_replace(";"," ",$natayej);

    	  $ravesh_ejra=str_replace("'"," ",$ravesh_ejra);
	      $ravesh_ejra=str_replace("\""," ",$ravesh_ejra);
	      $ravesh_ejra=str_replace(";"," ",$ravesh_ejra);

     	  $send_date=date("Y-m-d");
     	  $query="insert into  marhale_report set sazmanha='$sazmanha' ,pishnahadat='$pishnahadat', natije_giri='$natije_giri',natayej='$natayej',ravesh_ejra='$ravesh_ejra', marhale='100',cod_tarh='$cod_tarh',send_date='$send_date'";
	   	 
	   	  $r_update=mysql_query($query) or die("Error");
	       ?>
             <script language="javascript">
             window.location="<? echo "final_report.phtml?admin=$admin&seed=$seed&cod_tarh=$cod_tarh&step=2";  ?>";
             </script>
           <?
        
		}
		else
		{
		   $send_date=date("Y-m-d");
      	   $query="update  marhale_report set sazmanha='$sazmanha' ,pishnahadat='$pishnahadat', natije_giri='$natije_giri',natayej='$natayej',ravesh_ejra='$ravesh_ejra',send_date='$send_date' where    marhale='100' and cod_tarh='$cod_tarh'";
	   	// echo $query;
	   	   $r_update=mysql_query($query) or die("Error");
	       ?>
             <script language="javascript">
             window.location="<? echo "final_report.phtml?admin=$admin&seed=$seed&cod_tarh=$cod_tarh&step=2";  ?>";
             </script>
           <?
        	
		}
		
		  
     	}
     	else
     	  $status='entry_error';
     }
     
     if($step==2)
     {
     	$query="select * from  marhale_report where  marhale='100' and cod_tarh='$cod_tarh'";	 
		  
	   	$result=mysql_query($query) or die("Error");
     
	    if(mysql_num_rows($result) > 0)
	    {
	      $chekide_latin=str_replace("'"," ",$chekide_latin);
	      $chekide_latin=str_replace("\""," ",$chekide_latin);
	      $chekide_latin=str_replace(";"," ",$chekide_latin);

	 	  $send_date=date("Y-m-d");
     	  $query="update  marhale_report set chekide_latin='$chekide_latin' where marhale='100' and cod_tarh='$cod_tarh'";
	   	 
	   	  $r_update=mysql_query($query) or die("Error");
	   	   ?>
           <script language="javascript">
           window.location="<? echo "final_report.phtml?admin=$admin&seed=$seed&cod_tarh=$cod_tarh&step=3";  ?>";
           </script>
           <?

	    }
	    else
	    {
	      $status='step_error';	
	    }
     }
   
     if($step==3)
     {
     	$query="select * from  marhale_report where  marhale='100' and cod_tarh='$cod_tarh'";
		 	   	 
	   	$result=mysql_query($query) or die("Error");
	    
        if(strlen(trim($kalame_1))> 0  )
     	{
	    if(mysql_num_rows($result) > 0)
	    {
	    	
	      $kalame_1=str_replace("'"," ",$kalame_1);
	      $kalame_1=str_replace("\""," ",$kalame_1);
	      $kalame_1=str_replace(";"," ",$kalame_1);

	      $kalame_2=str_replace("'"," ",$kalame_2);
	      $kalame_2=str_replace("\""," ",$kalame_2);
	      $kalame_2=str_replace(";"," ",$kalame_2);

	      $kalame_3=str_replace("'"," ",$kalame_3);
	      $kalame_3=str_replace("\""," ",$kalame_3);
	      $kalame_3=str_replace(";"," ",$kalame_3);

	      $kalame_4=str_replace("'"," ",$kalame_4);
	      $kalame_4=str_replace("\""," ",$kalame_4);
	      $kalame_4=str_replace(";"," ",$kalame_4);
	    	
	 	  $send_date=date("Y-m-d");
     	  $query="update  marhale_report set kalame_1='$kalame_1',kalame_2='$kalame_2',kalame_3='$kalame_3',kalame_4='$kalame_4' where marhale='100' and cod_tarh='$cod_tarh'";
	   	 
	   	  $r_update=mysql_query($query) or die("Error");
	   	   ?>
           <script language="javascript">
           window.location="<? echo "final_report.phtml?admin=$admin&seed=$seed&cod_tarh=$cod_tarh&step=4";  ?>";
           </script>
           <?
	    }
	    
	    }
	    else
	      $status='entry_error';
	    
     }
     else 
	      $status='step_error';	
 
     
   
     
      if($step==4)
     {
     	$query="select * from  marhale_report where  marhale='100' and cod_tarh='$cod_tarh'";	   	 
	   	$result=mysql_query($query) or die("Error");
     
	    if(mysql_num_rows($result) > 0)
	    {
	 	  
	 	  
	 	  
	    $file_cnt=0;
        $dir_name="../reports/".$cod_tarh;
        if ($dir = @opendir($dir_name))
        {
     
          $mydir = dir($dir_name);
     //while(($file = $mydir->read()) !== false)
          while($file = $mydir->read())
	       if( !(strcmp(trim($file),".")==0 || strcmp(trim($file),"..")==0) )
	         $file_cnt++;
          closedir($dir);
     
        }
 
	    if($file_cnt < 18)
	    {
	      $send_date=date("Y-m-d");
	      $fupload_name=$_FILES["fupload"]["name"];
	      $fupload_name='final-'.$file_row.'-'.$send_date."-".$fupload_name;
	      
          $status_upload=upload_file("../reports",$cod_tarh,"$fupload_name");
          $query="update marhale_report set  filename='$fupload_name' where marhale='100' and cod_tarh='$cod_tarh'";
	   	 
	   	  $r_update=mysql_query($query) or die("Error");
          if(!strcmp($status_upload,"10") == 0 )
	         $status="upload_error";
	       ?>
           <script language="javascript">
           window.location="<? echo "final_report.phtml?admin=$admin&seed=$seed&cod_tarh=$cod_tarh&step=5";  ?>";
           </script>
           <?

	    }
        else
	      $status="exceed_upload";
	 	  
	 	  
	 	  
	 	  
	 	  
	 	  
    }
   else
    {
	   $status='step_error';	
	 }
    }
     
	 
      
	  $query="select * from group_karshenasan,group_karshenasan_tarh where group_karshenasan.cod_karshenas=group_karshenasan_tarh.cod_karshenas and  cod_tarh='$cod_tarh' and group_karshenasan.karshenas_type='1'";
      $result=mysql_query($query) or die("Error 120000");
	  $rf=mysql_fetch_array($result);
	  $sms_box=$rf["sms_box"]; 
	  $startdate =$send_date;
      $startyear = substr($startdate,0,4);
      $startmon = substr($startdate,5,2);
      $startday = substr($startdate,8,2);
      $send_date=hijricalender( $startyear , $startmon , $startday ); 
	 
	  $query="insert into input_sms set sms_from='ADMIN' ,sms_to='$sms_box' , sms_text='Gozaresh marboot be tarh $cod_tarh  dar tarikh   $send_date  ersal shod'";
	  $result=mysql_query($query) or die("Error 120000");
	     
  }
 
}

  
if(!isset($step))
  $step='1';
 echo "<form name=\"sabt_tarh\" method=\"post\"  enctype=\"multipart/form-data\" action=\"$PHP_SELF?action=sabt&admin=$admin&seed=$seed&cod_tarh=$cod_tarh&step=$step\">"; 
 
   $query="select * from tarh where cod_tarh='$cod_tarh'  and version='-1' ";

   $result=mysql_query($query) or die("Error in selecting data from tarh");
   if(mysql_num_rows($result) > 0)
   {
	 $row_fetched=mysql_fetch_array($result);
     $tarh_name = $row_fetched["tarh_title_farsi"];
 ?>
 

 <TABLE cellSpacing=0  width="600" cellPadding=2 border=0 bordercolor="#333333" style="border-style: solid; border-width: 1; ">

  <TR>

      <TD dir="rtl" align=center  class="tahoma1"  height=19 bgcolor="#EEE7F8" dir="rtl">
      <?
	   echo ""."عنوان طرح  : ".$tarh_name ;
      ?>
      </TD>
  </TR>
<TR>

      <TD dir="rtl" align=center  class="tahoma1"  height=19 bgcolor="#EEE7F8" dir="rtl"><b>
      <?
	   echo "<b>گزارشات ارسالي شما بايد به تاييد مدير دانشكده براي نظارت برسد</b>" ;
      ?></b>
      </TD>
  </TR>

</table>
<?
}
?>
<table border="0" width="600"  cellspacing="0" cellpadding="2"  bordercolor="#333333" style="border-style: solid; border-width: 1; ">
<?

$query="select * from  marhale_report where  marhale='100' and cod_tarh='$cod_tarh'";	   	 
$result=mysql_query($query) or die("Error");
if(mysql_num_rows($result) > 0)
{
  $rf=mysql_fetch_array($result);
  $ravesh_ejra=$rf["ravesh_ejra"];
  $natayej=$rf["natayej"];
  $natije_giri=$rf["natije_giri"];
  $pishnahadat=$rf["pishnahadat"];
  $chekide_latin=$rf["chekide_latin"];
  $kalame_1=$rf["kalame_1"];
  $kalame_2=$rf["kalame_2"];
  $kalame_3=$rf["kalame_3"];
  $kalame_4=$rf["kalame_4"];
  $sazmanha=$rf["sazmanha"];
  $filename_last=$rf["file_name"];
          
}
else
{
  $natayej='';
  $natije_giri='';
  $pishnahadat='';
  $chekide_latin='';
  $kalame_1='';
  $kalame_2='';
  $kalame_3='';
  $kalame_4='';
  $sazmanha='';	
  $filename_last="";
}

if (strcmp($status,"step_error") == 0)
  {
    echo "<tr>";
    echo "<td align=\"center\" class=\"error-message\" width=\"100%\" class=\"tahoma1\"  >قبل از ورود اين مرحله ، مرحله اول را ثبت كنيد</td>";
    echo "</tr>";
  }
 if (strcmp($status,"entry_error")==0)
  {
    echo "<tr>";
    echo "<td align=\"center\" class=\"error-message\" width=\"25%\" class=\"tahoma1\" colspan=\"2\">.مواردي که با ستاره مشخص شده اند را بطور کامل پر کنيد</td>";
    echo "</tr>";
  }
?>

<tr>   
    <td width="100%"   class="tahoma1" align='center' valign="top"><b>پس از پر شدن هر فرم با كليك روي مراحل بعدي قسمتهاي بعدي اين فرم را كامل كنيد</b></td>
  </tr>
  
<tr>   
    <td width="100%"   class="tahoma1" align='center' valign="top"><u><b>به ازاي هر فرم حتما بايد كليد ثبت را بزنيد</b></u></td>
  </tr>
  <tr>   
    <td width="100%"   class="tahoma1" align='center' valign="top">
	<?
	$step_string="مرحله اول";
	if(isset($step))
	  if($step==1)
	  {
	  	$step_string="<b>".$step_string."</b>";
	  }
	   echo "<a href='$PHP_SELF?admin=$admin&seed=$seed&step=1&cod_tarh=$cod_tarh'>".$step_string."</a>"; 
	?>
	  
    &nbsp;&nbsp;&nbsp;
    <?
	$step_string="مرحله دوم";
	if(isset($step))
	  if($step==2)
	  {
	  	$step_string="<b>".$step_string."</b>";
	  }
	 echo "<a href='$PHP_SELF?admin=$admin&seed=$seed&step=2&cod_tarh=$cod_tarh'>".$step_string."</a>"; 
	?>
	  &nbsp;&nbsp;&nbsp;  
	  <?
	$step_string="مرحله سوم";
	if(isset($step))
	  if($step==3)
	  {
	  	$step_string="<b>".$step_string."</b>";
	  }
	 echo "<a href='$PHP_SELF?admin=$admin&seed=$seed&step=3&cod_tarh=$cod_tarh'>".$step_string."</a>"; 
	?>                
	 
	 &nbsp;&nbsp;&nbsp;
	 
 
	
		<?
	$step_string="مرحله چهارم";
	if(isset($step))
	  if($step==4)
	  {
	  	$step_string="<b>".$step_string."</b>";
	  }
	 echo "<a href='$PHP_SELF?admin=$admin&seed=$seed&step=4&cod_tarh=$cod_tarh'>".$step_string."</a>"; 
	?>  
	 &nbsp;&nbsp;&nbsp;
	
		<?
	$step_string="مرحله پنجم";
	if(isset($step))
	  if($step==5)
	  {
	  	$step_string="<b>".$step_string."</b>";
	  }
	 echo "<a href='$PHP_SELF?admin=$admin&seed=$seed&step=5&cod_tarh=$cod_tarh'>".$step_string."</a>"; 
	?>  		
	</td>
  </tr>
 

</table>

<table border="0" width="600" bgcolor="#EEE7F8"   cellspacing="0" cellpadding="2"  bordercolor="#333333" style="border-style: solid; border-width: 1; ">

   
 <?
if($step==1)
{
?>
  <tr>   
    <td width="100%" colspan='2' class="tahoma1" align='center' valign="top"> فرم خلاصه گزارش نهايي</td>
  </tr>
  <tr>   
    <td width="100%" colspan='2' class="tahoma1" align='right' valign="top"> <b>چكيده فارسي</b></td>
  </tr>
  
  <tr>
    <td width="350" align="right"><textarea   rows="7"  name="ravesh_ejra" class="edit-user"  dir=RTL   > <? echo $ravesh_ejra; ?></textarea></td>
    <td width="250" class="tahoma1" valign="top"><span class="star-message">*</span>روش اجرا</td>
  </tr>
  
  
  
 <tr>
    <td width="350" align="right"><textarea   rows="7"  name="natayej" class="edit-user"  dir=RTL   > <? echo $natayej; ?></textarea></td>
    <td width="250" class="tahoma1" valign="top"><span class="star-message">*</span>نتايج</td>
  </tr> 
  <tr>   
    <td width="100%" colspan='2' class="tahoma1" align='right' valign="top"> <b>نتيجه گيري</b></td>
  </tr>
  <tr>
    <td width="350" align="right"><textarea   rows="7"  name="natije_giri" class="edit-user"   dir=RTL   ><? echo $natije_giri; ?></textarea></td>
    <td width="250" class="tahoma1" valign="top"> </td>
  </tr>

<tr>   
    <td width="100%" colspan='2' class="tahoma1" align='right' valign="top"> <b>پيشنهادها</b></td>
  </tr>
  <tr>
    <td width="350" align="right"><textarea   rows="7"  name="pishnahadat" class="edit-user"   dir=RTL   ><? echo $pishnahadat; ?></textarea></td>
    <td width="250" class="tahoma1" valign="top"> </td>
  </tr>
<tr>   
    <td width="100%" colspan='2' class="tahoma1" align='right' valign="top"> <b>سازمانهاي استفاده كننده از نتايج</b></td>
  </tr>
  <tr>
    <td width="350" align="right"><textarea   rows="7"  name="sazmanha" class="edit-user"   dir=RTL   ><? echo $sazmanha; ?></textarea></td>
    <td width="250" class="tahoma1" valign="top"> </td>
  </tr>
  <?
}
  ?>
  <?
if($step==2)
{
?>
  <tr>   
    <td width="100%" colspan='2' class="tahoma1" align='right' valign="top"> <b>چكيده لاتين</b></td>
  </tr>
  <tr>
    <td width="350" align="right"><textarea   rows="7"  name="chekide_latin" class="edit-user"  ><? echo $chekide_latin; ?></textarea></td>
    <td width="250" class="tahoma1" valign="top"> </td>
  </tr>
  <?
}
  ?>
 
<?
if($step==3)
{
?>

 <tr>   
    <td width="100%" colspan='2' class="tahoma1" align='right' valign="top"> <b>كلمات كليدي</b></td>
  </tr>
    <tr>
    <td width="350" align="right"><input type="text" name="kalame_1"  value="<? echo $kalame_1; ?>" size="20" class="edit-user" dir=RTL   ></td>
    <td width="250" class="tahoma1"><span class="star-message">*</span>كلمه اول</td>
  </tr>
 <tr>
    <td width="350" align="right"><input type="text" name="kalame_2"  value="<? echo $kalame_2; ?>" size="20" class="edit-user" dir=RTL   ></td>
    <td width="250" class="tahoma1"> كلمه دوم</td>
  </tr>
 <tr>
    <td width="350" align="right"><input type="text" name="kalame_3"  value="<? echo $kalame_3; ?>" size="20" class="edit-user" dir=RTL    ></td>
    <td width="250" class="tahoma1"> كلمه سوم</td>
  </tr>
  <tr>
    <td width="350" align="right"><input type="text" name="kalame_4"  value="<? echo $kalame_4; ?>" size="20" class="edit-user" dir=RTL   ></td>
    <td width="250" class="tahoma1"> كلمه چهارم</td>
  </tr>
   <tr>
    <td width="600" colspan='2' align='right' class="tahoma1">شما ميتوانيد تا 4 كلمه كليدي وارد نماييد. ثبت حداقل يك كلمه كليدي اجباري است. كلمه كليدي كلمه اي است كه مي توانيد با جستجوي آن به عنوان و هدف مقاله شما برسيد</td>
  </tr>
  <?
}
  
if($step==4)
{
?>
   <tr>
     <td width="100" align="right"><input type="file" name="fupload" class="edit-user"></td>
    <td width="400" class="tahoma1" valign="top" >فايل ضميمه<br> فايلهاي ضميمه با نام انگليسي معتبر هستند</td>

  </tr>
     <tr>
     <td width="100" align="right"><select size="1" name="file_row"  class="edit-user">
	<option selected selected value="1">نگارش اول</option>
	<option selected value="2">(نگارش دوم (اصلاحي اول</option>
	<option selected value="3">(نگارش سوم (اصلاحي دوم</option>
	<option selected value="4">(نگارش چهارم (اصلاحي سوم </option>
	<option selected value="5">(نگارش پنجم (اصلاحي چهارم</option>
	</select></td>
    <td width="400" class="tahoma1" valign="top" >(آيا اين فايل اولين نگارش فايل گزارش نهايي است يا نگارشهاي اصلاحي بعد از آن ميباشد؟ ( شماره نگارش را مشخص نماييد</td>

  </tr>
   <?
}
  ?>
    <?
if($step==5)
{
?>
   <tr>
     <td width="500" colspan='2' align="right" class="tahoma1" >آيين نامه اعتبار به طرح هاي تحقيقاتي</td>
   

  </tr>
   <?
}
  ?>
  <tr>
    <td width="100%" colspan="2">
      <p align="center"><input type="submit" value="ثبت" name="B1" class="but-small"></td>
  </tr>
</table>

</form>

<?
if($step==4)
{


 
  $query="select * from marhale_report where cod_tarh='$cod_tarh' and marhale='100'";
   
  $result=mysql_query($query) or die("Error");
   
    
      $mycount=0;
     $dir_name="../reports/".$cod_tarh;
     if ($dir = @opendir($dir_name))
     {
      echo "<table border=\"1\" cellspacing=\"0\" cellpadding=\"0\"  width=\"500\" >";
      echo "<tr>";
      echo "<td width=\"5%\"  align=\"center\" class=\"tahoma1\">حذف</td>";
      echo "<td width=\"20%\"  align=\"center\"  class=\"tahoma1\">نام فايل</td>";
    //  echo "<td width=\"20%\"  align=\"center\"  class=\"tahoma1\">تاريخ ارسال</td>";
      echo "</tr>";

     //echo $dir_name;
     $mydir = dir($dir_name);
     //while(($file = $mydir->read()) !== false)
     while($file = $mydir->read())
     {
	   if( !(strcmp(trim($file),".")==0 || strcmp(trim($file),"..")==0 || strcmp(trim($file),"Thumbs.db")==0) && strcmp(substr($file,0,5),'final')==0 )
	   {
         echo "<tr>";
         $myq="select * from tarh_indoing where cod_tarh='$cod_tarh' and marhale='100' and submitted='1'";
         $res=mysql_query($myq) or die("Error");
         if(mysql_num_rows($res)>0)
            $level_submitted='1';
         else 
            $level_submitted='0';  
     	
     	
	     echo "<tr>";
	     if($level_submitted==0)
             echo "<td ><p align=\"center\"><a href=\"#\" onclick='window.open(\"hazf_item_tarh.phtml?mainwindow=final_report.phtml&admin=$admin&seed=$seed&action=delete_file&marhale=$marhale&cod_tarh=".$cod_tarh."&delete_id=".$file."\",\"popupwindow\",\"toolbar=no,status=no,scrollbars=no,width=250,height=120,left=((screen.width-250) / 2),top=((screen.height - 120) / 2),resizable=no\")'><img border=\"0\" src=\"image/button_drop.png\" width=\"11\" height=\"13\" alt=\"Delete\" ></a></td>";
         else 
             echo "<td ><p align=\"center\" class='tahoma1'> غير قابل حذف</td>";    
       
         //echo "<td ><p align=\"center\"><a href=\"#\" onclick='window.open(\"hazf_item_tarh.phtml?mainwindow=upload_file.phtml&admin=$admin&seed=$seed&action=delete_file&cod_tarh=".$cod_tarh."&delete_id=".$file."\",\"popupwindow\",\"toolbar=no,status=no,scrollbars=no,width=250,height=120,left=((screen.width-250) / 2),top=((screen.height - 120) / 2),resizable=no\")'><img border=\"0\" src=\"image/button_drop.png\" width=\"11\" height=\"13\" alt=\"Delete\" ></a></td>";
         echo "<td align=\"center\"  class=\"tahoma1\"><a target=\"_blank\" href=\"../reports/$cod_tarh/$file\">".$file."</a></td>";
       //  echo "<td width=\"20%\"  align=\"center\"  class=\"tahoma1\">".$row_fetched["send_date"]."</td>";
        
		 echo "</tr>";
	   }
     }
      closedir($dir);
      echo "</table>";
	 }






	
}

  footer_forms($admin,$seed);
 ?>

<script>

            function setdefault()
            {
              document.sabt_tarh.cod_group.options[0].selected=true;

              document.sabt_tarh.cod_daneshkade.options[0].selected=true;
            }



            var temp=document.sabt_tarh.cod_group
            function redirect()
            {
              for (m=temp.options.length-1;m>0;m--)
                temp.options[m]=null
                var myselecteditem = this.sabt_tarh.cod_daneshkade.selectedIndex
                myselecteditem--
                if( myselecteditem<0 )
                  return

                for (i=0;i<group[myselecteditem].length;i++)
                {

                  temp.options[i]=new Option(group[myselecteditem][i].value,group[myselecteditem][i].text)
                }
                temp.options[0].selected=true
            }



            </script>


